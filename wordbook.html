<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æœ¬ - è‹±è¯­ç¿»è¯‘ç»ƒä¹ ç½‘ç«™</title>
    <link rel="stylesheet" href="styles.css?v=4">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>è‹±è¯­ç¿»è¯‘ç»ƒä¹ </h1>
                <div class="timer" id="timer" style="display: none;">00:00:00</div>
            </div>
            <div class="header-right">
                <a href="index.html" class="home-btn flat-btn" title="è¿”å›ä¸»é¡µ">ğŸ </a>
                <a href="javascript:void(0)" id="back-to-main" class="wordbook-icon" title="è¿”å›ç»ƒä¹ " onclick="handleBackToPractice()">ğŸ”™</a>
                <a href="translation-history.html" id="history-icon" class="history-btn flat-btn" title="ç¿»è¯‘å†å²">ğŸ“œ</a>
                <button id="install-app-btn" class="install-btn flat-btn hidden" title="å®‰è£…åº”ç”¨">ğŸ“¥</button>
            </div>
        </header>

        <!-- å•è¯æœ¬é¡µé¢ -->
        <section id="wordbook-section" class="active">
            <h2>å•è¯æœ¬</h2>
            <div class="wordbook-controls">
                <div class="search-container">
                    <input type="text" id="word-search" placeholder="æœç´¢å•è¯...">
                    <select id="word-sort">
                        <option value="alphabetical">æŒ‰å­—æ¯æ’åº</option>
                        <option value="recent">æŒ‰æ·»åŠ æ—¶é—´æ’åº</option>
                        <option value="frequency">æŒ‰é¢‘ç‡æ’åº</option>
                    </select>
                </div>
                <div class="import-export-buttons">
                    <input type="file" id="import-excel" accept=".xlsx,.csv" style="display: none;">
                    <button id="import-excel-btn" class="action-btn">å¯¼å…¥Excel/CSV</button>
                    <button id="export-excel-btn" class="action-btn">å¯¼å‡ºExcel</button>
                    <button id="clear-wordbook-btn" class="action-btn">æ¸…ç©ºå•è¯æœ¬</button>
                </div>
            </div>
            <div class="wordbook-stats">
                <p>å…± <span id="total-words">0</span> ä¸ªå•è¯</p>
            </div>
            <div class="word-cards-container" id="word-cards-container">
                <!-- å•è¯å¡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- åˆ†é¡µå¯¼èˆªåŒºåŸŸ -->
            <div class="pagination-container" id="pagination-container">
                <div class="pagination-info">
                    <span id="page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" id="first-page-btn" title="ç¬¬ä¸€é¡µ">â®</button>
                    <button class="pagination-btn" id="prev-page-btn" title="ä¸Šä¸€é¡µ">â—€</button>
                    <div class="page-numbers" id="page-numbers">
                        <!-- é¡µç å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <button class="pagination-btn" id="next-page-btn" title="ä¸‹ä¸€é¡µ">â–¶</button>
                    <button class="pagination-btn" id="last-page-btn" title="æœ€åä¸€é¡µ">â­</button>
                    <div class="page-jump">
                        <input type="number" id="page-jump-input" class="page-jump-input" placeholder="é¡µç " min="1">
                        <button class="pagination-btn" id="page-jump-btn" title="è·³è½¬">è·³è½¬</button>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <a href="javascript:void(0)" class="back-btn flat-btn" onclick="handleBackToPractice()">è¿”å›ç»ƒä¹ </a>
            </div>
        </section>
    </div>

    <!-- ç‰ˆæƒä¿¡æ¯ -->
    <footer class="footer">
        <p class="copyright">æœ¬ç½‘é¡µç”±AIç”Ÿæˆï¼Œç”Ÿæˆè€…æœ¬äººä¸æ‡‚ç½‘é¡µå¼€å‘ï¼Œæœ€åˆç›®æ ‡åªæ˜¯è‡ªç”¨ï¼Œå¤§ç¥æµ·æ¶µ</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="html2canvas.min.js"></script>
    <script src="script.js?v=4"></script>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="theme-toggle-btn" class="theme-toggle-btn" title="æ›´æ¢ä¸»é¢˜" aria-label="æ›´æ¢ä¸»é¢˜" aria-expanded="false">ğŸ¨</button>
    
    <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button id="mode-toggle-btn" class="mode-toggle-btn" title="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-label="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-pressed="false">ğŸŒ™</button>
    
    <!-- ä¸»é¢˜é€‰æ‹©é¢æ¿ -->
    <div id="theme-panel" class="theme-panel hidden" role="menu" aria-labelledby="theme-toggle-btn">
        <div class="theme-panel-header">
            <h3>é€‰æ‹©ä¸»é¢˜</h3>
            <button id="close-theme-panel" class="close-btn" aria-label="å…³é—­ä¸»é¢˜é¢æ¿">&times;</button>
        </div>
        <div class="theme-colors">
            <h4>ä¸»é¢˜é¢œè‰²</h4>
            <div class="color-options">
                <button class="color-option" data-color="blue" style="background-color: #2196F3" title="è“è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="red" style="background-color: #F44336" title="çº¢è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="yellow" style="background-color: #FFC107" title="é»„è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="green" style="background-color: #4CAF50" title="ç»¿è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="purple" style="background-color: #9C27B0" title="ç´«è‰²ä¸»é¢˜" aria-pressed="false"></button>
            </div>
        </div>
    </div>
    <script>
        // å•è¯æœ¬é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // PWAå®‰è£…äº‹ä»¶å¤„ç†
            let deferredPrompt = null;
            const installAppBtn = document.getElementById('install-app-btn');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                if (installAppBtn) {
                    installAppBtn.classList.remove('hidden');
                    
                    installAppBtn.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to the install prompt: ${outcome}`);
                            
                            if (outcome === 'accepted') {
                                console.log('User accepted the install prompt');
                            } else {
                                console.log('User dismissed the install prompt');
                            }
                            
                            deferredPrompt = null;
                            installAppBtn.classList.add('hidden');
                        }
                    });
                }
            });
        
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                if (installAppBtn) {
                    installAppBtn.classList.add('hidden');
                }
                deferredPrompt = null;
            });
            
            // ç¡®ä¿wordbookå˜é‡å¯ç”¨
            window.wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
            window.filteredWords = [...window.wordbook];
            
            // æ¸²æŸ“å•è¯å¡
            renderWordCards();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateWordbookStats();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const wordSearch = document.getElementById('word-search');
            const wordSort = document.getElementById('word-sort');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const clearWordbookBtn = document.getElementById('clear-wordbook-btn');
            const importExcel = document.getElementById('import-excel');
            
            wordSearch.addEventListener('input', handleSearchAndSort);
            wordSort.addEventListener('change', handleSearchAndSort);
            clearWordbookBtn.addEventListener('click', clearWordbook);
            exportExcelBtn.addEventListener('click', exportExcel);
            importExcelBtn.addEventListener('click', () => importExcel.click());
            importExcel.addEventListener('change', importExcelFile);
            
            // åˆ†é¡µæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('first-page-btn').addEventListener('click', goToFirstPage);
            document.getElementById('prev-page-btn').addEventListener('click', goToPrevPage);
            document.getElementById('next-page-btn').addEventListener('click', goToNextPage);
            document.getElementById('last-page-btn').addEventListener('click', goToLastPage);
            
            // é¡µé¢è·³è½¬åŠŸèƒ½
            const pageJumpInput = document.getElementById('page-jump-input');
            const pageJumpBtn = document.getElementById('page-jump-btn');
            
            pageJumpBtn.addEventListener('click', () => {
                const pageNumber = parseInt(pageJumpInput.value);
                if (pageNumber && pageNumber >= 1 && pageNumber <= totalPages) {
                    goToPage(pageNumber);
                    pageJumpInput.value = '';
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ï¼');
                }
            });
            
            // æ”¯æŒæŒ‰å›è½¦é”®è·³è½¬
            pageJumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    pageJumpBtn.click();
                }
            });
        });
        
        // å¤„ç†è¿”å›ç»ƒä¹ åŠŸèƒ½
        function handleBackToPractice() {
            try {
                // ä½¿ç”¨PageTransitionçš„å†å²è®°å½•ç³»ç»Ÿè·å–ä¸Šä¸€ä¸ªé¡µé¢
                if (window.PageTransition && window.PageTransition.history) {
                    const previousPage = window.PageTransition.history.getPrevious();
                    
                    if (previousPage && previousPage !== window.location.pathname) {
                        // ä½¿ç”¨PageTransitionè¿›è¡Œé¡µé¢è·³è½¬
                        window.PageTransition.navigateTo(previousPage);
                    } else {
                        // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œè¿”å›åˆ°ä¸»é¡µé¢
                        window.PageTransition.navigateTo('index.html');
                    }
                } else {
                    // å¦‚æœPageTransitionä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤è¿”å›é€»è¾‘
                    window.history.back();
                }
            } catch (error) {
                console.error('è¿”å›ç»ƒä¹ å¤±è´¥:', error);
                // å‡ºé”™æ—¶è¿”å›åˆ°ä¸»é¡µé¢
                window.location.href = 'index.html';
            }
        }
        
        // åˆ†é¡µç›¸å…³å˜é‡
        const WORDS_PER_PAGE = 9;
        let currentPage = 1;
        let totalPages = 1;
        
        // æ¸²æŸ“å•è¯å¡
        function renderWordCards() {
            const wordCardsContainer = document.getElementById('word-cards-container');
            const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
            
            wordCardsContainer.innerHTML = '';
            
            if (window.filteredWords.length === 0) {
                wordCardsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 50px;">å•è¯æœ¬ä¸ºç©º</p>';
                updatePaginationControls();
                return;
            }
            
            // è®¡ç®—æ€»é¡µæ•°
            totalPages = Math.ceil(window.filteredWords.length / WORDS_PER_PAGE);
            
            // ç¡®ä¿å½“å‰é¡µç åœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (currentPage > totalPages) {
                currentPage = totalPages;
            }
            if (currentPage < 1) {
                currentPage = 1;
            }
            
            // è®¡ç®—å½“å‰é¡µçš„å•è¯ç´¢å¼•èŒƒå›´
            const startIndex = (currentPage - 1) * WORDS_PER_PAGE;
            const endIndex = Math.min(startIndex + WORDS_PER_PAGE, window.filteredWords.length);
            const currentPageWords = window.filteredWords.slice(startIndex, endIndex);
            
            currentPageWords.forEach((wordData, index) => {
                const actualIndex = startIndex + index;
                const wordCard = document.createElement('div');
                wordCard.className = 'word-card';
                
                // è·å–ä¸»è¦é‡Šä¹‰
                const mainMeaning = wordData.meanings?.[0];
                const mainDefinition = mainMeaning?.definition || '';
                const mainChinese = mainMeaning?.chinese || '';
                const partOfSpeech = mainMeaning?.partOfSpeech || '';
                
                // è·å–ä¾‹å¥
                const examples = wordData.examples || [];
                const examplesHTML = examples.slice(0, 3).map(ex => `
                    <div class="example">
                        <div class="example-english">${ex.english || ''}</div>
                        <div class="example-chinese">${ex.chinese || ''}</div>
                        ${ex.context ? `<div class="example-context"><small>è¯­å¢ƒ: ${ex.context}</small></div>` : ''}
                    </div>
                `).join('');
                
                // è·å–ä½¿ç”¨ä¿¡æ¯
                const usage = wordData.usage || {};
                const usageHTML = `
                    <div class="usage-info">
                        ${usage.frequency ? `<small>é¢‘ç‡: ${usage.frequency}</small>` : ''}
                        ${usage.register ? `<small>è¯­ä½“: ${usage.register}</small>` : ''}
                        ${usage.type ? `<small>ç±»å‹: ${usage.type}</small>` : ''}
                        ${usage.commonUsage ? `<small>ç”¨æ³•: ${usage.commonUsage}</small>` : ''}
                    </div>
                `;
                
                wordCard.innerHTML = `
                    <div class="word-card-inner">
                        <div class="word-card-front">
                            <button class="remove-btn" data-index="${actualIndex}">Ã—</button>
                            <h3>${wordData.word}</h3>
                            ${wordData.phonetic ? `<div class="phonetic">${wordData.phonetic}</div>` : ''}
                            ${partOfSpeech ? `<div class="part-of-speech">${partOfSpeech}</div>` : ''}
                            <p>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</p>
                        </div>
                        <div class="word-card-back">
                            <button class="remove-btn" data-index="${actualIndex}">Ã—</button>
                            <div class="header-section">
                                <h3>${wordData.word}</h3>
                                ${wordData.phonetic ? `<div class="phonetic">${wordData.phonetic}</div>` : ''}
                                ${partOfSpeech ? `<div class="part-of-speech">${partOfSpeech}</div>` : ''}
                            </div>
                            <div class="content-section">
                                <div class="meaning-section">
                                    <div class="definition">
                                        ${mainChinese ? `<strong>ä¸­æ–‡é‡Šä¹‰:</strong> ${mainChinese}` : ''}
                                        ${mainDefinition ? `<div><strong>è‹±æ–‡é‡Šä¹‰:</strong> ${mainDefinition}</div>` : ''}
                                    </div>
                                </div>
                                
                                ${examplesHTML ? `
                                    <div class="examples-section">
                                        <strong>ä¾‹å¥:</strong>
                                        ${examplesHTML}
                                    </div>
                                ` : ''}
                                
                                ${usageHTML ? `
                                    <div class="usage-section">
                                        ${usageHTML}
                                    </div>
                                ` : ''}
                                
                                <div class="word-meta">
                                    <small>æ·»åŠ äº: ${new Date(wordData.addedAt).toLocaleDateString()}</small>
                                    <small>æŸ¥çœ‹æ¬¡æ•°: ${wordData.frequency || 0}</small>
                                    ${wordData.source ? `<small>æ¥æº: ${wordData.source}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                wordCardsContainer.appendChild(wordCard);
                
                // æ·»åŠ ç¿»è½¬äº‹ä»¶
                wordCard.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸ç¿»è½¬
                    if (e.target.classList.contains('remove-btn')) return;
                    wordCard.classList.toggle('flipped');
                });
                
                // æ·»åŠ åˆ é™¤äº‹ä»¶
                const removeBtn = wordCard.querySelector('.remove-btn');
                removeBtn.addEventListener('click', () => {
                    removeWordFromWordbook(actualIndex);
                });
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePaginationControls();
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePaginationControls() {
            const pageInfo = document.getElementById('page-info');
            const pageNumbers = document.getElementById('page-numbers');
            const firstPageBtn = document.getElementById('first-page-btn');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const lastPageBtn = document.getElementById('last-page-btn');
            const pageJumpInput = document.getElementById('page-jump-input');
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            if (window.filteredWords.length === 0) {
                pageInfo.textContent = 'ç¬¬ 0 é¡µ / å…± 0 é¡µ';
                pageJumpInput.disabled = true;
                pageJumpInput.placeholder = 'æ— é¡µç ';
            } else {
                pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
                pageJumpInput.disabled = false;
                pageJumpInput.placeholder = 'é¡µç ';
                pageJumpInput.max = totalPages;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstPageBtn.disabled = currentPage <= 1 || window.filteredWords.length === 0;
            prevPageBtn.disabled = currentPage <= 1 || window.filteredWords.length === 0;
            nextPageBtn.disabled = currentPage >= totalPages || window.filteredWords.length === 0;
            lastPageBtn.disabled = currentPage >= totalPages || window.filteredWords.length === 0;
            
            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbers.innerHTML = '';
            
            if (window.filteredWords.length === 0) {
                return;
            }
            
            // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // å¦‚æœæ€»é¡µæ•°è¾ƒå°‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            if (totalPages <= 5) {
                startPage = 1;
                endPage = totalPages;
            } else {
                // ç¡®ä¿è‡³å°‘æ˜¾ç¤º5ä¸ªé¡µç 
                if (endPage - startPage < 4) {
                    if (startPage === 1) {
                        endPage = Math.min(5, totalPages);
                    } else if (endPage === totalPages) {
                        startPage = Math.max(1, totalPages - 4);
                    }
                }
            }
            
            // æ·»åŠ ç¬¬ä¸€é¡µå’Œçœç•¥å·
            if (startPage > 1) {
                const firstPageNum = document.createElement('button');
                firstPageNum.className = 'page-number';
                firstPageNum.textContent = '1';
                firstPageNum.addEventListener('click', () => goToPage(1));
                pageNumbers.appendChild(firstPageNum);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageNum = document.createElement('button');
                pageNum.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageNum.textContent = i;
                pageNum.addEventListener('click', () => goToPage(i));
                pageNumbers.appendChild(pageNum);
            }
            
            // æ·»åŠ æœ€åä¸€é¡µå’Œçœç•¥å·
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageNum = document.createElement('button');
                lastPageNum.className = 'page-number';
                lastPageNum.textContent = totalPages;
                lastPageNum.addEventListener('click', () => goToPage(totalPages));
                pageNumbers.appendChild(lastPageNum);
            }
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µé¢
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderWordCards();
        }
        
        // ç¬¬ä¸€é¡µ
        function goToFirstPage() {
            goToPage(1);
        }
        
        // ä¸Šä¸€é¡µ
        function goToPrevPage() {
            goToPage(currentPage - 1);
        }
        
        // ä¸‹ä¸€é¡µ
        function goToNextPage() {
            goToPage(currentPage + 1);
        }
        
        // æœ€åä¸€é¡µ
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        // ä»å•è¯æœ¬ä¸­åˆ é™¤å•è¯
        function removeWordFromWordbook(index) {
            if (confirm('ç¡®å®šè¦ä»å•è¯æœ¬ä¸­åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) {
                const removedWord = window.filteredWords[index];
                const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
                const actualIndex = wordbook.findIndex(w => w.word === removedWord.word);
                if (actualIndex >= 0) {
                    wordbook.splice(actualIndex, 1);
                    localStorage.setItem('wordbook', JSON.stringify(wordbook));
                    window.wordbook = wordbook;
                    filterAndSortWords();
                }
            }
        }
        
        // è¿‡æ»¤å’Œæ’åºå•è¯
        function filterAndSortWords() {
            const wordSearch = document.getElementById('word-search');
            const wordSort = document.getElementById('word-sort');
            const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
            
            const searchTerm = wordSearch.value.toLowerCase();
            const sortBy = wordSort.value;
            
            // è¿‡æ»¤
            window.filteredWords = wordbook.filter(word => 
                word.word.toLowerCase().includes(searchTerm)
            );
            
            // æ’åº
            switch (sortBy) {
                case 'alphabetical':
                    window.filteredWords.sort((a, b) => a.word.localeCompare(b.word));
                    break;
                case 'recent':
                    window.filteredWords.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
                    break;
                case 'frequency':
                    window.filteredWords.sort((a, b) => b.frequency - a.frequency);
                    break;
            }
            
            // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            currentPage = 1;
            
            renderWordCards();
        }
        
        // æœç´¢å’Œæ’åºäº‹ä»¶å¤„ç†
        function handleSearchAndSort() {
            filterAndSortWords();
        }
        
        // æ¸…ç©ºå•è¯æœ¬
        function clearWordbook() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå•è¯æœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                localStorage.removeItem('wordbook');
                window.wordbook = [];
                window.filteredWords = [];
                renderWordCards();
                updateWordbookStats();
            }
        }
        
        // å¯¼å‡ºExcelåŠŸèƒ½
        function exportExcel() {
            const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
            
            if (wordbook.length === 0) {
                alert('å•è¯æœ¬ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
                return;
            }
            
            // è½¬æ¢æ•°æ®æ ¼å¼ï¼ŒåŒ…å«å®Œæ•´ä¿¡æ¯
            const exportData = wordbook.map(word => {
                // è·å–ä¸»è¦é‡Šä¹‰
                const mainMeaning = word.meanings?.[0];
                const mainDefinition = mainMeaning?.definition || '';
                const mainChinese = mainMeaning?.chinese || '';
                const partOfSpeech = mainMeaning?.partOfSpeech || '';
                
                // è·å–ä¾‹å¥
                const examples = word.examples || [];
                const example1 = examples[0]?.english || '';
                const example1Chinese = examples[0]?.chinese || '';
                const example2 = examples[1]?.english || '';
                const example2Chinese = examples[1]?.chinese || '';
                const example3 = examples[2]?.english || '';
                const example3Chinese = examples[2]?.chinese || '';
                
                // è·å–ä½¿ç”¨ä¿¡æ¯
                const usage = word.usage || {};
                const usageFrequency = usage.frequency || '';
                const usageRegister = usage.register || '';
                const usageType = usage.type || '';
                const usageCommon = usage.commonUsage || '';
                
                return {
                    'å•è¯': word.word,
                    'éŸ³æ ‡': word.phonetic || '',
                    'è¯æ€§': partOfSpeech,
                    'ä¸­æ–‡é‡Šä¹‰': mainChinese,
                    'è‹±æ–‡é‡Šä¹‰': mainDefinition,
                    'ä¾‹å¥1': example1,
                    'ä¾‹å¥1ç¿»è¯‘': example1Chinese,
                    'ä¾‹å¥2': example2,
                    'ä¾‹å¥2ç¿»è¯‘': example2Chinese,
                    'ä¾‹å¥3': example3,
                    'ä¾‹å¥3ç¿»è¯‘': example3Chinese,
                    'ä½¿ç”¨é¢‘ç‡': usageFrequency,
                    'è¯­ä½“': usageRegister,
                    'ç±»å‹': usageType,
                    'å¸¸ç”¨ç”¨æ³•': usageCommon,
                    'æ·»åŠ æ—¶é—´': new Date(word.addedAt).toLocaleString(),
                    'æŸ¥çœ‹æ¬¡æ•°': word.frequency || 0,
                    'æ¥æº': word.source || ''
                };
            });
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const headers = Object.keys(exportData[0]);
            const csvContent = [
                headers.join(','),
                ...exportData.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å•è¯æœ¬_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // å¯¼å…¥Excel/CSVåŠŸèƒ½
        function importExcelFile() {
            const importExcel = document.getElementById('import-excel');
            const file = importExcel.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                importCSVFile(file);
            } else if (fileExtension === 'xlsx') {
                importExcelFileXLSX(file);
            } else {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·é€‰æ‹© .xlsx æˆ– .csv æ–‡ä»¶ã€‚');
                importExcel.value = '';
            }
        }
        
        // å¯¼å…¥CSVæ–‡ä»¶
        function importCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
                
                let importedCount = 0;
                let existingCount = 0;
                const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split(',').map(v => v.replace(/"/g, ''));
                    const wordData = {};
                    
                    headers.forEach((header, index) => {
                        wordData[header] = values[index] || '';
                    });
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„å•è¯æ•°æ®
                    if (wordData['å•è¯']) {
                        const existingWordIndex = wordbook.findIndex(w => w.word.toLowerCase() === wordData['å•è¯'].toLowerCase());
                        
                        if (existingWordIndex >= 0) {
                            existingCount++;
                        } else {
                            const newWord = createWordFromData(wordData);
                            wordbook.push(newWord);
                            importedCount++;
                        }
                    }
                }
                
                saveImportedData(wordbook, importedCount, existingCount);
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // å¯¼å…¥Excelæ–‡ä»¶
        function importExcelFileXLSX(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    let importedCount = 0;
                    let existingCount = 0;
                    const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
                    
                    jsonData.forEach(row => {
                        if (row['å•è¯']) {
                            const existingWordIndex = wordbook.findIndex(w => w.word.toLowerCase() === row['å•è¯'].toLowerCase());
                            
                            if (existingWordIndex >= 0) {
                                existingCount++;
                            } else {
                                const newWord = createWordFromData(row);
                                wordbook.push(newWord);
                                importedCount++;
                            }
                        }
                    });
                    
                    saveImportedData(wordbook, importedCount, existingCount);
                } catch (error) {
                    console.error('Excelæ–‡ä»¶è§£æå¤±è´¥:', error);
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
                    document.getElementById('import-excel').value = '';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // ä»æ•°æ®åˆ›å»ºå•è¯å¯¹è±¡
        function createWordFromData(wordData) {
            const examples = [];
            for (let j = 1; j <= 3; j++) {
                const exampleKey = `ä¾‹å¥${j}`;
                const exampleTransKey = `ä¾‹å¥${j}ç¿»è¯‘`;
                if (wordData[exampleKey]) {
                    examples.push({
                        english: wordData[exampleKey],
                        chinese: wordData[exampleTransKey] || '',
                        context: 'å¯¼å…¥æ•°æ®'
                    });
                }
            }
            
            return {
                word: wordData['å•è¯'],
                phonetic: wordData['éŸ³æ ‡'] || '',
                meanings: [{
                    partOfSpeech: wordData['è¯æ€§'] || 'unknown',
                    definition: wordData['è‹±æ–‡é‡Šä¹‰'] || '',
                    chinese: wordData['ä¸­æ–‡é‡Šä¹‰'] || '',
                    context: 'å¯¼å…¥æ•°æ®'
                }],
                examples: examples,
                usage: {
                    frequency: wordData['ä½¿ç”¨é¢‘ç‡'] || '',
                    register: wordData['è¯­ä½“'] || '',
                    type: wordData['ç±»å‹'] || '',
                    commonUsage: wordData['å¸¸ç”¨ç”¨æ³•'] || ''
                },
                source: wordData['æ¥æº'] || 'import',
                addedAt: new Date().toISOString(),
                frequency: parseInt(wordData['æŸ¥çœ‹æ¬¡æ•°']) || 1
            };
        }
        
        // ä¿å­˜å¯¼å…¥çš„æ•°æ®å¹¶æ›´æ–°ç•Œé¢
        function saveImportedData(wordbook, importedCount, existingCount) {
            localStorage.setItem('wordbook', JSON.stringify(wordbook));
            window.wordbook = wordbook;
            filterAndSortWords();
            updateWordbookStats();
            alert(`å¯¼å…¥å®Œæˆï¼æ–°æ·»åŠ  ${importedCount} ä¸ªå•è¯ï¼Œå·²å­˜åœ¨ ${existingCount} ä¸ªå•è¯`);
            document.getElementById('import-excel').value = '';
        }
        
        // æ›´æ–°å•è¯æœ¬ç»Ÿè®¡ä¿¡æ¯
        function updateWordbookStats() {
            const totalWordsEl = document.getElementById('total-words');
            const wordbook = JSON.parse(localStorage.getItem('wordbook')) || [];
            totalWordsEl.textContent = wordbook.length;
        }
        
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>