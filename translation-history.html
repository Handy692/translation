<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¯‘å†å² - è‹±è¯­ç¿»è¯‘ç»ƒä¹ ç½‘ç«™</title>
    <link rel="stylesheet" href="styles.css?v=4">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>è‹±è¯­ç¿»è¯‘ç»ƒä¹ </h1>
                <div class="timer" id="timer" style="display: none;">00:00:00</div>
            </div>
            <div class="header-right">
                <a href="index.html" class="home-btn flat-btn" title="è¿”å›ä¸»é¡µ">ğŸ </a>
                <a href="wordbook.html" id="wordbook-icon" class="wordbook-icon" title="å•è¯æœ¬">ğŸ“š</a>
                <a href="translation-history.html" id="history-icon" class="history-btn flat-btn" title="ç¿»è¯‘å†å²">ğŸ“œ</a>
                <button id="install-app-btn" class="install-btn flat-btn hidden" title="å®‰è£…åº”ç”¨">ğŸ“¥</button>
            </div>
        </header>

        <!-- ç¿»è¯‘å†å²é¡µé¢ -->
        <section id="translation-history" class="active">
            <h2>ç¿»è¯‘å†å²</h2>
            
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <div class="history-tabs">
                <button class="history-tab active" data-tab="versions">
                    <div class="tab-content">
                        <span class="tab-title">ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬</span>
                        <span class="tab-description">æŸ¥çœ‹å’Œç®¡ç†ç¿»è¯‘çš„å†å²ç‰ˆæœ¬è®°å½•</span>
                    </div>
                </button>
                <button class="history-tab" data-tab="files">
                    <div class="tab-content">
                        <span class="tab-title">å†å²ç¿»è¯‘æ–‡ç« </span>
                        <span class="tab-description">æŸ¥çœ‹å’Œç®¡ç†å†å²ç¿»è¯‘æ–‡ä»¶</span>
                    </div>
                </button>
            </div>
            
            <!-- ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬åŒºåŸŸ -->
            <div class="history-section" id="versions-section">
                <div class="history-controls">
                    <button id="export-history-btn" class="back-btn">å¯¼å‡ºå†å²æ•°æ®</button>
                    <label for="import-history-file" class="back-btn" style="cursor: pointer; display: inline-block; margin-left: 10px;">å¯¼å…¥å†å²æ•°æ®</label>
                    <input type="file" id="import-history-file" accept=".json" style="display: none;">
                    <button id="clear-history-versions-btn" class="back-btn" style="margin-left: 10px; background-color: #ff4444;">æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬</button>
                </div>
                <div id="history-versions-list" class="history-list">
                    <!-- å†å²ç‰ˆæœ¬è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="no-history-message">æš‚æ— ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬è®°å½•</div>
                </div>
                <!-- åˆ†é¡µå¯¼èˆªåŒºåŸŸ -->
                <div class="pagination-container" id="versions-pagination-container">
                    <div class="pagination-info">
                        <span id="versions-page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="versions-first-page-btn" title="ç¬¬ä¸€é¡µ">â®</button>
                        <button class="pagination-btn" id="versions-prev-page-btn" title="ä¸Šä¸€é¡µ">â—€</button>
                        <div class="page-numbers" id="versions-page-numbers">
                            <!-- é¡µç å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button class="pagination-btn" id="versions-next-page-btn" title="ä¸‹ä¸€é¡µ">â–¶</button>
                        <button class="pagination-btn" id="versions-last-page-btn" title="æœ€åä¸€é¡µ">â­</button>
                        <div class="page-jump">
                            <input type="number" id="versions-page-jump-input" class="page-jump-input" placeholder="é¡µç " min="1">
                            <button class="pagination-btn" id="versions-page-jump-btn" title="è·³è½¬">è·³è½¬</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å†å²ç¿»è¯‘æ–‡ç« åŒºåŸŸ -->
            <div class="history-section hidden" id="files-section">
                <div class="history-controls">
                    <button id="clear-history-files-btn" class="back-btn" style="background-color: #ff4444;">æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶</button>
                </div>
                <div id="history-files-list" class="history-list">
                    <!-- å†å²æ–‡ä»¶è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    <div class="no-history-message">æš‚æ— å†å²ç¿»è¯‘æ–‡ç« è®°å½•</div>
                </div>
                <!-- åˆ†é¡µå¯¼èˆªåŒºåŸŸ -->
                <div class="pagination-container" id="files-pagination-container">
                    <div class="pagination-info">
                        <span id="files-page-info">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="files-first-page-btn" title="ç¬¬ä¸€é¡µ">â®</button>
                        <button class="pagination-btn" id="files-prev-page-btn" title="ä¸Šä¸€é¡µ">â—€</button>
                        <div class="page-numbers" id="files-page-numbers">
                            <!-- é¡µç å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <button class="pagination-btn" id="files-next-page-btn" title="ä¸‹ä¸€é¡µ">â–¶</button>
                        <button class="pagination-btn" id="files-last-page-btn" title="æœ€åä¸€é¡µ">â­</button>
                        <div class="page-jump">
                            <input type="number" id="files-page-jump-input" class="page-jump-input" placeholder="é¡µç " min="1">
                            <button class="pagination-btn" id="files-page-jump-btn" title="è·³è½¬">è·³è½¬</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- ç‰ˆæƒä¿¡æ¯ -->
    <footer class="footer">
        <p class="copyright">æœ¬ç½‘é¡µç”±AIç”Ÿæˆï¼Œç”Ÿæˆè€…æœ¬äººä¸æ‡‚ç½‘é¡µå¼€å‘ï¼Œæœ€åˆç›®æ ‡åªæ˜¯è‡ªç”¨ï¼Œå¤§ç¥æµ·æ¶µ</p>
    </footer>

    <script src="script.js?v=4"></script>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="theme-toggle-btn" class="theme-toggle-btn" title="æ›´æ¢ä¸»é¢˜" aria-label="æ›´æ¢ä¸»é¢˜" aria-expanded="false">ğŸ¨</button>
    
    <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button id="mode-toggle-btn" class="mode-toggle-btn" title="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-label="åˆ‡æ¢é»‘æš—/ç™½å¤©æ¨¡å¼" aria-pressed="false">ğŸŒ™</button>
    
    <!-- ä¸»é¢˜é€‰æ‹©é¢æ¿ -->
    <div id="theme-panel" class="theme-panel hidden" role="menu" aria-labelledby="theme-toggle-btn">
        <div class="theme-panel-header">
            <h3>é€‰æ‹©ä¸»é¢˜</h3>
            <button id="close-theme-panel" class="close-btn" aria-label="å…³é—­ä¸»é¢˜é¢æ¿">&times;</button>
        </div>
        <div class="theme-colors">
            <h4>ä¸»é¢˜é¢œè‰²</h4>
            <div class="color-options">
                <button class="color-option" data-color="blue" style="background-color: #2196F3" title="è“è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="red" style="background-color: #F44336" title="çº¢è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="yellow" style="background-color: #FFC107" title="é»„è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="green" style="background-color: #4CAF50" title="ç»¿è‰²ä¸»é¢˜" aria-pressed="false"></button>
                <button class="color-option" data-color="purple" style="background-color: #9C27B0" title="ç´«è‰²ä¸»é¢˜" aria-pressed="false"></button>
            </div>
        </div>
    </div>
    <script>
        // ç¿»è¯‘å†å²é¡µé¢ç‰¹å®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // PWAå®‰è£…äº‹ä»¶å¤„ç†
            let deferredPrompt = null;
            const installAppBtn = document.getElementById('install-app-btn');
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                if (installAppBtn) {
                    installAppBtn.classList.remove('hidden');
                    
                    installAppBtn.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to the install prompt: ${outcome}`);
                            
                            if (outcome === 'accepted') {
                                console.log('User accepted the install prompt');
                            } else {
                                console.log('User dismissed the install prompt');
                            }
                            
                            deferredPrompt = null;
                            installAppBtn.classList.add('hidden');
                        }
                    });
                }
            });
        
            window.addEventListener('appinstalled', () => {
                console.log('PWA was installed');
                if (installAppBtn) {
                    installAppBtn.classList.add('hidden');
                }
                deferredPrompt = null;
            });
            
            // åˆå§‹åŒ–ç¿»è¯‘å†å²é¡µé¢
            initTranslationHistory();
        });

        // åˆ†é¡µç›¸å…³å˜é‡ - å†å²ç‰ˆæœ¬
        const VERSIONS_PER_PAGE = 6;
        let versionsCurrentPage = 1;
        let versionsTotalPages = 1;
        
        // åˆ†é¡µç›¸å…³å˜é‡ - å†å²æ–‡ä»¶
        const FILES_PER_PAGE = 6;
        let filesCurrentPage = 1;
        let filesTotalPages = 1;

        // åˆå§‹åŒ–ç¿»è¯‘å†å²é¡µé¢
        function initTranslationHistory() {
            // åŠ è½½ç¿»è¯‘å†å²æ•°æ®
            loadTranslationHistory();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            setupHistoryEventListeners();
            
            // åˆå§‹åŒ–é€‰é¡¹å¡
            initTabs();
            
            // åˆå§‹åŒ–åˆ†é¡µäº‹ä»¶ç›‘å¬å™¨
            initPaginationEventListeners();
        }

        // åˆå§‹åŒ–åˆ†é¡µäº‹ä»¶ç›‘å¬å™¨
        function initPaginationEventListeners() {
            // å†å²ç‰ˆæœ¬åˆ†é¡µäº‹ä»¶
            document.getElementById('versions-first-page-btn').addEventListener('click', () => goToVersionsPage(1));
            document.getElementById('versions-prev-page-btn').addEventListener('click', () => goToVersionsPage(versionsCurrentPage - 1));
            document.getElementById('versions-next-page-btn').addEventListener('click', () => goToVersionsPage(versionsCurrentPage + 1));
            document.getElementById('versions-last-page-btn').addEventListener('click', () => goToVersionsPage(versionsTotalPages));
            
            const versionsPageJumpInput = document.getElementById('versions-page-jump-input');
            const versionsPageJumpBtn = document.getElementById('versions-page-jump-btn');
            
            versionsPageJumpBtn.addEventListener('click', () => {
                const pageNumber = parseInt(versionsPageJumpInput.value);
                if (pageNumber && pageNumber >= 1 && pageNumber <= versionsTotalPages) {
                    goToVersionsPage(pageNumber);
                    versionsPageJumpInput.value = '';
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ï¼');
                }
            });
            
            versionsPageJumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    versionsPageJumpBtn.click();
                }
            });
            
            // å†å²æ–‡ä»¶åˆ†é¡µäº‹ä»¶
            document.getElementById('files-first-page-btn').addEventListener('click', () => goToFilesPage(1));
            document.getElementById('files-prev-page-btn').addEventListener('click', () => goToFilesPage(filesCurrentPage - 1));
            document.getElementById('files-next-page-btn').addEventListener('click', () => goToFilesPage(filesCurrentPage + 1));
            document.getElementById('files-last-page-btn').addEventListener('click', () => goToFilesPage(filesTotalPages));
            
            const filesPageJumpInput = document.getElementById('files-page-jump-input');
            const filesPageJumpBtn = document.getElementById('files-page-jump-btn');
            
            filesPageJumpBtn.addEventListener('click', () => {
                const pageNumber = parseInt(filesPageJumpInput.value);
                if (pageNumber && pageNumber >= 1 && pageNumber <= filesTotalPages) {
                    goToFilesPage(pageNumber);
                    filesPageJumpInput.value = '';
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ï¼');
                }
            });
            
            filesPageJumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filesPageJumpBtn.click();
                }
            });
        }

        // åˆå§‹åŒ–é€‰é¡¹å¡
        function initTabs() {
            const tabs = document.querySelectorAll('.history-tab');
            const versionsSection = document.getElementById('versions-section');
            const filesSection = document.getElementById('files-section');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡çš„activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // ä¸ºå½“å‰é€‰é¡¹å¡æ·»åŠ activeç±»
                    this.classList.add('active');
                    
                    // è·å–é€‰é¡¹å¡ç±»å‹
                    const tabType = this.getAttribute('data-tab');
                    
                    // åˆ‡æ¢å†…å®¹åŒºåŸŸ
                    if (tabType === 'versions') {
                        versionsSection.classList.remove('hidden');
                        filesSection.classList.add('hidden');
                        loadHistoryVersions();
                    } else {
                        versionsSection.classList.add('hidden');
                        filesSection.classList.remove('hidden');
                        loadHistoryFiles();
                    }
                });
            });
        }

        // åŠ è½½ç¿»è¯‘å†å²æ•°æ®
        function loadTranslationHistory() {
            // åŠ è½½ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬
            loadHistoryVersions();
            
            // åŠ è½½å†å²ç¿»è¯‘æ–‡ç« 
            loadHistoryFiles();
        }

        // åŠ è½½ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬
        function loadHistoryVersions() {
            const historyList = document.getElementById('history-versions-list');
            const versions = TranslationHistory.getHistoryVersions();
            
            historyList.innerHTML = '';
            
            if (versions.length === 0) {
                historyList.innerHTML = '<div class="no-history-message">æš‚æ— ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬è®°å½•</div>';
                updateVersionsPaginationControls();
                return;
            }
            
            // è®¡ç®—æ€»é¡µæ•°
            versionsTotalPages = Math.ceil(versions.length / VERSIONS_PER_PAGE);
            
            // ç¡®ä¿å½“å‰é¡µç åœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (versionsCurrentPage > versionsTotalPages) {
                versionsCurrentPage = versionsTotalPages;
            }
            if (versionsCurrentPage < 1) {
                versionsCurrentPage = 1;
            }
            
            // è®¡ç®—å½“å‰é¡µçš„è®°å½•ç´¢å¼•èŒƒå›´
            const startIndex = (versionsCurrentPage - 1) * VERSIONS_PER_PAGE;
            const endIndex = Math.min(startIndex + VERSIONS_PER_PAGE, versions.length);
            const currentPageVersions = versions.slice(startIndex, endIndex);
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            currentPageVersions.reverse().forEach((version, index) => {
                const actualIndex = startIndex + (currentPageVersions.length - 1 - index);
                const versionItem = document.createElement('div');
                versionItem.className = 'history-item';
                
                const timestamp = new Date(version.timestamp).toLocaleString('zh-CN');
                
                versionItem.innerHTML = `
                    <div class="history-item-header">
                        <h3>${version.filename || 'æœªå‘½åæ–‡ä»¶'}</h3>
                        <span class="history-timestamp">${timestamp}</span>
                    </div>
                    <div class="history-item-content">
                        <p class="history-item-description">${version.description || 'æ— æè¿°'}</p>
                        ${version.passageContent ? `<div class="history-item-passage"><strong>åŸæ–‡ï¼š</strong><p>${version.passageContent.substring(0, 200)}${version.passageContent.length > 200 ? '...' : ''}</p></div>` : ''}
                        ${version.score !== null ? `<div class="history-item-score"><strong>è¯„åˆ†ï¼š</strong>${version.score}/100</div>` : ''}
                        ${version.aiEvaluation ? `<div class="history-item-ai-evaluation"><strong>AIè¯„è¯­ï¼š</strong><p>${version.aiEvaluation.substring(0, 300)}${version.aiEvaluation.length > 300 ? '...' : ''}</p></div>` : ''}
                    </div>
                    <div class="history-item-actions">
                        <button class="back-btn" onclick="loadHistoryVersion('${version.id}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="back-btn" style="background-color: #ff4444;" onclick="deleteHistoryVersion('${version.id}')">åˆ é™¤</button>
                    </div>
                `;
                
                historyList.appendChild(versionItem);
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updateVersionsPaginationControls();
        }
        
        // æ›´æ–°å†å²ç‰ˆæœ¬åˆ†é¡µæ§ä»¶
        function updateVersionsPaginationControls() {
            const pageInfo = document.getElementById('versions-page-info');
            const pageNumbers = document.getElementById('versions-page-numbers');
            const firstPageBtn = document.getElementById('versions-first-page-btn');
            const prevPageBtn = document.getElementById('versions-prev-page-btn');
            const nextPageBtn = document.getElementById('versions-next-page-btn');
            const lastPageBtn = document.getElementById('versions-last-page-btn');
            const pageJumpInput = document.getElementById('versions-page-jump-input');
            const versions = TranslationHistory.getHistoryVersions();
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            if (versions.length === 0) {
                pageInfo.textContent = 'ç¬¬ 0 é¡µ / å…± 0 é¡µ';
                pageJumpInput.disabled = true;
                pageJumpInput.placeholder = 'æ— é¡µç ';
            } else {
                pageInfo.textContent = `ç¬¬ ${versionsCurrentPage} é¡µ / å…± ${versionsTotalPages} é¡µ`;
                pageJumpInput.disabled = false;
                pageJumpInput.placeholder = 'é¡µç ';
                pageJumpInput.max = versionsTotalPages;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstPageBtn.disabled = versionsCurrentPage <= 1 || versions.length === 0;
            prevPageBtn.disabled = versionsCurrentPage <= 1 || versions.length === 0;
            nextPageBtn.disabled = versionsCurrentPage >= versionsTotalPages || versions.length === 0;
            lastPageBtn.disabled = versionsCurrentPage >= versionsTotalPages || versions.length === 0;
            
            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbers.innerHTML = '';
            
            if (versions.length === 0) {
                return;
            }
            
            // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, versionsCurrentPage - 2);
            let endPage = Math.min(versionsTotalPages, versionsCurrentPage + 2);
            
            // å¦‚æœæ€»é¡µæ•°è¾ƒå°‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            if (versionsTotalPages <= 5) {
                startPage = 1;
                endPage = versionsTotalPages;
            } else {
                // ç¡®ä¿è‡³å°‘æ˜¾ç¤º5ä¸ªé¡µç 
                if (endPage - startPage < 4) {
                    if (startPage === 1) {
                        endPage = Math.min(5, versionsTotalPages);
                    } else if (endPage === versionsTotalPages) {
                        startPage = Math.max(1, versionsTotalPages - 4);
                    }
                }
            }
            
            // æ·»åŠ ç¬¬ä¸€é¡µå’Œçœç•¥å·
            if (startPage > 1) {
                const firstPageNum = document.createElement('button');
                firstPageNum.className = 'page-number';
                firstPageNum.textContent = '1';
                firstPageNum.addEventListener('click', () => goToVersionsPage(1));
                pageNumbers.appendChild(firstPageNum);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageNum = document.createElement('button');
                pageNum.className = `page-number ${i === versionsCurrentPage ? 'active' : ''}`;
                pageNum.textContent = i;
                pageNum.addEventListener('click', () => goToVersionsPage(i));
                pageNumbers.appendChild(pageNum);
            }
            
            // æ·»åŠ æœ€åä¸€é¡µå’Œçœç•¥å·
            if (endPage < versionsTotalPages) {
                if (endPage < versionsTotalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageNum = document.createElement('button');
                lastPageNum.className = 'page-number';
                lastPageNum.textContent = versionsTotalPages;
                lastPageNum.addEventListener('click', () => goToVersionsPage(versionsTotalPages));
                pageNumbers.appendChild(lastPageNum);
            }
        }
        
        // è·³è½¬åˆ°å†å²ç‰ˆæœ¬æŒ‡å®šé¡µé¢
        function goToVersionsPage(page) {
            if (page < 1 || page > versionsTotalPages) return;
            versionsCurrentPage = page;
            loadHistoryVersions();
        }

        // åŠ è½½å†å²ç¿»è¯‘æ–‡ç« 
        function loadHistoryFiles() {
            const filesList = document.getElementById('history-files-list');
            const files = TranslationHistory.getHistoryFiles();
            
            filesList.innerHTML = '';
            
            if (files.length === 0) {
                filesList.innerHTML = '<div class="no-history-message">æš‚æ— å†å²ç¿»è¯‘æ–‡ç« è®°å½•</div>';
                updateFilesPaginationControls();
                return;
            }
            
            // è®¡ç®—æ€»é¡µæ•°
            filesTotalPages = Math.ceil(files.length / FILES_PER_PAGE);
            
            // ç¡®ä¿å½“å‰é¡µç åœ¨æœ‰æ•ˆèŒƒå›´å†…
            if (filesCurrentPage > filesTotalPages) {
                filesCurrentPage = filesTotalPages;
            }
            if (filesCurrentPage < 1) {
                filesCurrentPage = 1;
            }
            
            // è®¡ç®—å½“å‰é¡µçš„è®°å½•ç´¢å¼•èŒƒå›´
            const startIndex = (filesCurrentPage - 1) * FILES_PER_PAGE;
            const endIndex = Math.min(startIndex + FILES_PER_PAGE, files.length);
            const currentPageFiles = files.slice(startIndex, endIndex);
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            currentPageFiles.reverse().forEach((file, index) => {
                const actualIndex = startIndex + (currentPageFiles.length - 1 - index);
                const fileItem = document.createElement('div');
                fileItem.className = 'history-item';
                
                const timestamp = new Date(file.timestamp).toLocaleString('zh-CN');
                
                fileItem.innerHTML = `
                    <div class="history-item-header">
                        <h3>${file.filename || 'æœªå‘½åæ–‡ä»¶'}</h3>
                        <span class="history-timestamp">${timestamp}</span>
                    </div>
                    <div class="history-item-content">
                        <p class="history-item-description">${file.description || 'æ— æè¿°'}</p>
                    </div>
                    <div class="history-item-actions">
                        <button class="back-btn" onclick="reloadHistoryFile('${file.id}')">é‡æ–°åŠ è½½</button>
                        <button class="back-btn" style="background-color: #ff4444;" onclick="deleteHistoryFile('${file.id}')">åˆ é™¤</button>
                    </div>
                `;
                
                filesList.appendChild(fileItem);
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updateFilesPaginationControls();
        }
        
        // æ›´æ–°å†å²æ–‡ä»¶åˆ†é¡µæ§ä»¶
        function updateFilesPaginationControls() {
            const pageInfo = document.getElementById('files-page-info');
            const pageNumbers = document.getElementById('files-page-numbers');
            const firstPageBtn = document.getElementById('files-first-page-btn');
            const prevPageBtn = document.getElementById('files-prev-page-btn');
            const nextPageBtn = document.getElementById('files-next-page-btn');
            const lastPageBtn = document.getElementById('files-last-page-btn');
            const pageJumpInput = document.getElementById('files-page-jump-input');
            const files = TranslationHistory.getHistoryFiles();
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            if (files.length === 0) {
                pageInfo.textContent = 'ç¬¬ 0 é¡µ / å…± 0 é¡µ';
                pageJumpInput.disabled = true;
                pageJumpInput.placeholder = 'æ— é¡µç ';
            } else {
                pageInfo.textContent = `ç¬¬ ${filesCurrentPage} é¡µ / å…± ${filesTotalPages} é¡µ`;
                pageJumpInput.disabled = false;
                pageJumpInput.placeholder = 'é¡µç ';
                pageJumpInput.max = filesTotalPages;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            firstPageBtn.disabled = filesCurrentPage <= 1 || files.length === 0;
            prevPageBtn.disabled = filesCurrentPage <= 1 || files.length === 0;
            nextPageBtn.disabled = filesCurrentPage >= filesTotalPages || files.length === 0;
            lastPageBtn.disabled = filesCurrentPage >= filesTotalPages || files.length === 0;
            
            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbers.innerHTML = '';
            
            if (files.length === 0) {
                return;
            }
            
            // è®¡ç®—æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, filesCurrentPage - 2);
            let endPage = Math.min(filesTotalPages, filesCurrentPage + 2);
            
            // å¦‚æœæ€»é¡µæ•°è¾ƒå°‘ï¼Œæ˜¾ç¤ºæ‰€æœ‰é¡µç 
            if (filesTotalPages <= 5) {
                startPage = 1;
                endPage = filesTotalPages;
            } else {
                // ç¡®ä¿è‡³å°‘æ˜¾ç¤º5ä¸ªé¡µç 
                if (endPage - startPage < 4) {
                    if (startPage === 1) {
                        endPage = Math.min(5, filesTotalPages);
                    } else if (endPage === filesTotalPages) {
                        startPage = Math.max(1, filesTotalPages - 4);
                    }
                }
            }
            
            // æ·»åŠ ç¬¬ä¸€é¡µå’Œçœç•¥å·
            if (startPage > 1) {
                const firstPageNum = document.createElement('button');
                firstPageNum.className = 'page-number';
                firstPageNum.textContent = '1';
                firstPageNum.addEventListener('click', () => goToFilesPage(1));
                pageNumbers.appendChild(firstPageNum);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
            }
            
            // æ·»åŠ é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                const pageNum = document.createElement('button');
                pageNum.className = `page-number ${i === filesCurrentPage ? 'active' : ''}`;
                pageNum.textContent = i;
                pageNum.addEventListener('click', () => goToFilesPage(i));
                pageNumbers.appendChild(pageNum);
            }
            
            // æ·»åŠ æœ€åä¸€é¡µå’Œçœç•¥å·
            if (endPage < filesTotalPages) {
                if (endPage < filesTotalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '10px 5px';
                    ellipsis.style.color = 'var(--text-secondary)';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastPageNum = document.createElement('button');
                lastPageNum.className = 'page-number';
                lastPageNum.textContent = filesTotalPages;
                lastPageNum.addEventListener('click', () => goToFilesPage(filesTotalPages));
                pageNumbers.appendChild(lastPageNum);
            }
        }
        
        // è·³è½¬åˆ°å†å²æ–‡ä»¶æŒ‡å®šé¡µé¢
        function goToFilesPage(page) {
            if (page < 1 || page > filesTotalPages) return;
            filesCurrentPage = page;
            loadHistoryFiles();
        }

        // è®¾ç½®å†å²äº‹ä»¶ç›‘å¬å™¨
        function setupHistoryEventListeners() {
            // å¯¼å‡ºå†å²æ•°æ®
            document.getElementById('export-history-btn').addEventListener('click', exportHistoryData);
            
            // å¯¼å…¥å†å²æ•°æ®
            document.getElementById('import-history-file').addEventListener('change', importHistoryData);
            
            // æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬
            document.getElementById('clear-history-versions-btn').addEventListener('click', clearAllHistoryVersions);
            
            // æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶
            document.getElementById('clear-history-files-btn').addEventListener('click', clearAllHistoryFiles);
        }

        // åŠ è½½å†å²ç‰ˆæœ¬
        function loadHistoryVersion(versionId) {
            const versions = TranslationHistory.getHistoryVersions();
            const version = versions.find(v => v.id === versionId);
            
            if (version) {
                // å°†å†å²ç‰ˆæœ¬æ•°æ®ä¿å­˜åˆ°sessionStorage
                sessionStorage.setItem('historyVersionToView', JSON.stringify(version));
                
                // è·³è½¬åˆ°è¯„ä»·é¡µé¢
                window.location.href = '4_evaluation.html?historyVersion=true';
            } else {
                showMessage('æœªæ‰¾åˆ°è¯¥å†å²ç‰ˆæœ¬è®°å½•', 'error');
            }
        }

        // åˆ é™¤å†å²ç‰ˆæœ¬
        function deleteHistoryVersion(versionId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å†å²ç‰ˆæœ¬å—ï¼Ÿ')) {
                if (TranslationHistory.deleteHistoryVersion(versionId)) {
                    showMessage('å†å²ç‰ˆæœ¬åˆ é™¤æˆåŠŸï¼', 'success');
                    loadHistoryVersions();
                } else {
                    showMessage('å†å²ç‰ˆæœ¬åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            }
        }

        // é‡æ–°åŠ è½½å†å²æ–‡ä»¶
        function reloadHistoryFile(fileId) {
            const files = TranslationHistory.getHistoryFiles();
            const file = files.find(f => f.id === fileId);
            
            if (file) {
                // å°†æ–‡ä»¶æ•°æ®ä¿å­˜åˆ°sessionStorageï¼Œç„¶åè·³è½¬åˆ°ç›¸åº”çš„ç»ƒä¹ é¡µé¢
                sessionStorage.setItem('reloadedHistoryFile', JSON.stringify(file));
                showMessage('æ­£åœ¨é‡æ–°åŠ è½½å†å²æ–‡ä»¶...', 'info');
                // è·³è½¬åˆ°ä¸Šä¼ é¡µé¢ï¼Œç”±ä¸Šä¼ é¡µé¢å¤„ç†é‡æ–°åŠ è½½é€»è¾‘
                window.location.href = 'index.html?reloadFile=true';
            }
        }

        // åˆ é™¤å†å²æ–‡ä»¶
        function deleteHistoryFile(fileId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å†å²æ–‡ä»¶å—ï¼Ÿ')) {
                if (TranslationHistory.deleteHistoryFile(fileId)) {
                    showMessage('å†å²æ–‡ä»¶åˆ é™¤æˆåŠŸï¼', 'success');
                    loadHistoryFiles();
                } else {
                    showMessage('å†å²æ–‡ä»¶åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²ç‰ˆæœ¬
        function clearAllHistoryVersions() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¿»è¯‘æ–‡ç« å†å²ç‰ˆæœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (TranslationHistory.clearAllHistoryVersions()) {
                    showMessage('æ‰€æœ‰å†å²ç‰ˆæœ¬å·²æ¸…ç©ºï¼', 'success');
                    loadHistoryVersions();
                } else {
                    showMessage('æ¸…ç©ºå†å²ç‰ˆæœ¬å¤±è´¥ï¼', 'error');
                }
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²æ–‡ä»¶
        function clearAllHistoryFiles() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²ç¿»è¯‘æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (TranslationHistory.clearAllHistoryFiles()) {
                    showMessage('æ‰€æœ‰å†å²æ–‡ä»¶å·²æ¸…ç©ºï¼', 'success');
                    loadHistoryFiles();
                } else {
                    showMessage('æ¸…ç©ºå†å²æ–‡ä»¶å¤±è´¥ï¼', 'error');
                }
            }
        }

        // å¯¼å‡ºå†å²æ•°æ®
        function exportHistoryData() {
            const historyData = TranslationHistory.exportHistoryData();
            
            const dataStr = JSON.stringify(historyData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `translation-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showMessage('å†å²æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
        }

        // å¯¼å…¥å†å²æ•°æ®
        function importHistoryData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const historyData = JSON.parse(e.target.result);
                    
                    if (TranslationHistory.importHistoryData(historyData)) {
                        showMessage('å†å²æ•°æ®å¯¼å…¥æˆåŠŸï¼', 'success');
                        loadTranslationHistory();
                    } else {
                        showMessage('å†å²æ•°æ®å¯¼å…¥å¤±è´¥ï¼', 'error');
                    }
                } catch (error) {
                    console.error('Error importing history data:', error);
                    showMessage('å†å²æ•°æ®å¯¼å…¥å¤±è´¥ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚', 'error');
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(messageEl);
            
            // æ˜¾ç¤ºæ¶ˆæ¯
            setTimeout(() => {
                messageEl.style.opacity = '1';
            }, 100);
            
            // 3ç§’åéšè—æ¶ˆæ¯
            setTimeout(() => {
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 3000);
        }
        
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
    
    <!-- å¸®åŠ©æŒ‰é’® -->
    <a href="about_me.html" class="help-btn" title="å…³äºæˆ‘">?</a>
</body>
</html>